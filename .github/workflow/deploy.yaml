name: CI-CD-K8S

on:
  push:
    branches:
      - main

env:
  IMAGE_NAME: deepthi2911/hrgf-task

jobs:
  build-scan-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Docker Login
      run: |
        echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login \
        -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin

    - name: Build Docker Image
      run: |
        docker build -t ${{ secrets.REGISTRY_USERNAME }}/$IMAGE_NAME:latest .

    - name: Trivy Scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ secrets.REGISTRY_USERNAME }}/deepthi2911/hrgf-task:latest
        severity: CRITICAL,HIGH
        exit-code: 1

    - name: Push Image
      run: |
        docker push ${{ secrets.REGISTRY_USERNAME }}/$IMAGE_NAME:latest

    - name: Set kubeconfig
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config

    - name: Deploy via Helm
      run: |
        helm upgrade --install hello-app helm/hello-app \
        --set image.repository=${{ secrets.REGISTRY_USERNAME }}/hello-app

